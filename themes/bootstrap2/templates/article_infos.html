<footer class="post-info">
<!-- <span class="label">Date</span>
<abbr class="published" title="{{ article.date.isoformat() }}">
        <i class="icon-calendar"></i>{{ article.locale_date }}
</abbr> -->
<p>
        <span class="label" id="title_label">Title</span>
        <a href="{{ SITEURL }}/{{ article.url }}" id="article_url"><i><nobr id="article_title">{{ article.title }}</nobr></i>
                {% if article.volume %}
                        [{{ article.volume }}]
                {% endif %}
        </a>
</p>
<span class="label">By</span>
{% if article.authors %}
        {% for author in article.authors %}
                <a href="{{ SITEURL }}/{{ author.url }}">
                        <i class="icon-user"></i>
                        <nobr>{{ author }}</nobr>
                </a>
        {% endfor %}
{% elif article.author %}
        <a href="{{ SITEURL }}/{{ article.author.url }}">
                <i class="icon-user"></i>
                <nobr>{{ article.author }}</nobr>
        </a>
{% endif %}
<span class="label">Year</span>
<a class="published" title="{{ article.year }}"><i class="icon-calendar"></i>{{ article.year }}</a>
<span class="label">Added</span>
<a class="published" title="{{ article.date.isoformat() }}"><i class="icon-calendar"></i>{{ article.locale_date }}</a>
{% if article.journal %}
        <span class="label">Journal</span>
        {{ article.journal }}
{% endif %}
{% if article.booktitle %}
        <span class="label">Booktitle</span>
        {{ article.booktitle }}
{% endif %}
{% if article.thedoiurl or article.theurl %}
        <span class="label">URL</span>
        {% if article.thedoiurl %}
                <a href="{{ article.thedoiurl }}" target="_blank">[doi]</a>
        {% endif %}
        {% if article.theurl %}
                <a href="{{ article.theurl }}" target="_blank">[url]</a>
        {% endif %}
{% endif %}
<!-- <span class="label">Key</span> -->
<a hidden><nobr>{{ article.key }}</nobr></a>
{% if article.pdffiles or article.pdffile %}
        <span class="label" id="PDF_label">PDF</span>
        {% if article.pdffiles %}
                {% for pdffile in article.pdffiles %}
                [<a href="{{ GITHUB_VIEW_URL }}/{{ pdffile | urlencode }}" target="_blank">pdf</a> | <a href="pdfefile:///SyncedFolders/bibliographer/{{ pdffile | replace('./', '', 1) | urlencode | replace(":","%3A") }}">pdfe</a>]
                {% endfor %}
        {% elif article.pdffile %}
                [<a href="{{ GITHUB_VIEW_URL }}/{{ article.pdffile | urlencode }}" target="_blank">pdf</a> |
                 <a href="pdfefile:///SyncedFolders/bibliographer/{{ article.pdffile | replace('./', '', 1) | urlencode | replace(':','%3A') }}">pdfe</a>]
                 <!-- | <a href="pdfefile:///SyncedFolders/bibliographer/{{ article.pdffile | replace('./', '', 1) }}">pdfe2</a> -->
        {% endif %}
{% endif %}
<span class="label">BIB</span>
        <a href="javascript:copyBib()">[copy]</a>
        {% if article.doi %}
                <a href="{{ SITEURL }}/doi/{{ article.doi }}" target="_blank">[cite]</a>
        {% endif %}
        <!-- <a href="{{ SITEURL }}/{{ article.bibfile }}">[bib]</a> -->
        <a href="{{ GITHUB_EDIT_URL }}/{{ article.bibfile }}" target="_blank">[edit]</a>
        <a href="{{ GITHUB_RAW_URL }}/{{ article.bibfile }}" target="_blank" id="github_bib">[raw]</a>
{% if article.tags %}
        <span class="label">Tags</span>
                {% for tag in article.tags %}
                        <a href="{{ SITEURL }}/{{ tag.url }}"><i class="icon-tag"></i>{{ tag }}</a>
                {% endfor %}
{% endif %}
<!-- {% if article.keywords %}
        <span class="label">Keywords</span>
                {% for keyword in article.keywords %}
                        <a href="{{ SITEURL }}/{{ keyword.url }}"><i class="icon-tag"></i>{{ keyword }}</a>
                {% endfor %}
{% endif %} -->
<span class="label">SRC</span>
        <a href="{{ GITHUB_EDIT_URL }}/{{ article.rootfolder }}" id="article_rootfolder" target="_blank">[edit]</a>
<span class="label">FILES</span>
        <a href="http://172.28.1.15:4444/filebrowser/files/Media/Library/bibliographer/{{ article.rootfolder }}" id="article_filebrowser" target="_blank">[open]</a>
<br>
<form id="editEntryForm" autocomplete="off">
        <span class="label">Tags</span>
        <div class="autocomplete keywords-field">
                <input type="text" id="keywords" name="keywords" autocomplete="off" class="chip-input" placeholder="Keywords"/>
                <div class="chips"></div>
                <div class="progress-bar" id="keywords-progress"></div>
        </div>
        <input type="submit" value="Save" id="save">
</form>
</footer>
<script type="module">
        import {statusAppend, getWebPage, getXmlHttp, lowerize} from 'https://lclem.github.io/librarian/theme/js/util.js';
        import {getWebPageAdvanced, loadTextArray, changeEvent, keyEnterEvent, preventDefaults} from '{{ SITEURL }}/theme/js/util.js';
        import {autocomplete} from '{{ SITEURL }}/theme/js/autocomplete.js';
        import {addChipListener, chips2string, initialiseChips} from '{{ SITEURL }}/theme/js/chips.js';
        // import {openGitHub, uploadFile} from 'https://lclem.github.io/librarian/theme/js/github.js';
        import {uploadFileToGitHub} from '{{ SITEURL }}/theme/js/github.js';

        var keywords = [];
        var bibJSON = null;

        const keywordsProgressBar = document.getElementById("keywords-progress");
        const inputKeywords = document.getElementById('keywords');
        const saveButton = document.getElementById('save');
        const form = document.getElementById('editEntryForm');

        // async function openBibFileGitHub(repository, fullFileName, bibStr) {
        //         var url = "https://github.com/lclem/" + repository + "/new/main/";
        //         url += "?filename=" + fullFileName + "&value=";
        //         url += encodeURIComponent(bibStr);
        //         // statusAppend("openGitHub, repo: " + repository + ", key: " + sanitisedKey + ", fileName: " + fileName + ", bibStr: " + bibStr + " = " + url);
        //         window.open(url, "_blank");
        //         return url;
        // }

        form.addEventListener('submit', preventDefaults, false);
        form.addEventListener('submit', event => {
                if (bibJSON) {
                        const bibStr = bibtexParse.toBibtex([bibJSON], false).trim();
                        const key = bibJSON.citationKey;
                        console.log(bibStr);
                        uploadFileToGitHub("bibliographer", "{{ article.bibfile }}", "{{ article.BibFileName }}", bibStr);
                }
        }, false);

        loadTextArray("{{ SITEURL }}/keywords.txt", entries => {
                keywords = entries;
                autocomplete(inputKeywords, keywords, keyword => {
                        addKeyword(inputKeywords, keyword);
                        inputKeywords.value = '';
                });
        }, keywordsProgressBar);

        function keywordsHaveChanged() {
                // update the list of keywords
                const keywordsStr = chips2string(inputKeywords);
                bibJSON.entryTags["keywords"] = keywordsStr;
        }

        addChipListener(inputKeywords);
        initialiseChips(keywordsHaveChanged);

        const bibA = document.getElementById('github_bib');
        const bibHref = bibA.href;
        console.log("bib href: " + bibHref);

        getWebPage(bibHref, bibStr => {
                console.log("bibStr: " + bibStr);
                try {
                        var bibJSONs = bibtexParse.toJSON(bibStr);

                        if (bibJSONs.length == 0)
                                return;

                        bibJSON = bibJSONs[0];
                        var tags = lowerize(bibJSON.entryTags);
                        console.log("tags: " + JSON.stringify(tags));

                        var keywordsStr = tags["keywords"];

                        if (!keywordsStr)
                                keywordsStr = "";
                        
                        var keywords = keywordsStr.replaceAll(", ", " and ").split(" and ");
                        console.log("keywords: " + keywords);

                        for (const keyword of keywords) {
                                inputKeywords.value = keyword;
                                inputKeywords.dispatchEvent(changeEvent);
                                inputKeywords.dispatchEvent(keyEnterEvent);
                        }
                }
                catch (err) {
                        console.error('Failed to parse bib: ', err);
                }
        });
</script>
